(()=>{"use strict";class e{constructor(){if(e._instance)return e._instance;e._instance=this,this.onPoster=!1,this.clickDown=!1}static getInstance(){return e._instance?e._instance:new ProgramCore}canRotate(){return!this.onPoster&&!this.clickDown}}const t={pointerX:0,pointerY:0,focusX:0,focusY:0,rotateDeg:0};let n=!0;const o=[],s="https://wnfa-interactive-art-project.github.io/hangzhou_060122/";function r(t,n){const r=[];let i,a,c=!1;const l=t=>{const n=document.createElement("img"),o=80*Math.random(),s=80*Math.random(),r=360*Math.random(),i=6*Math.random()+2;return n.classList.add("poster"),n.onerror=()=>{this.style.display="none"},n.draggable=!1,n.style.top=s+"%",n.style.right=o+"%",n.style.transform=`rotateZ(${r}deg) rotateY(${r}deg)`,n.style.height=i+"em",n.src=t,n.onmouseenter=()=>{e.getInstance().onPoster=!0,n.classList.add("focus")},n.onmouseleave=()=>{e.getInstance().onPoster=!1,n.classList.remove("focus")},n.onclick=()=>{e.getInstance().onPoster=!1,n.classList.remove("focus");const o=document.querySelector("#site-poster-detail-layer"),s=document.createElement("img");s.classList.add("show"),s.src=t,m((()=>{o.classList.add("show"),o.appendChild(s),o.onclick=()=>{o.onclick=()=>{},o.classList.remove("show"),setTimeout((()=>{o.removeChild(s),g((()=>{}))}),500)}}))},n},d=e=>{o[Math.floor(Math.random()*o.length)].appendChild(e),r.push(e),setTimeout((()=>{c||e.classList.add("show")}),100)},u=()=>{if(0!==r.length){const e=r.shift();e.classList.remove("show"),setTimeout((()=>{e.parentElement.removeChild(e)}),500)}},h=(e=(()=>{}))=>{for(;0!==r.length;)u();e()},m=(e=(()=>{}))=>{c=!0;for(let e=0;e<r.length;e++)r[e].classList.remove("show");e()},g=(e=(()=>{}))=>{for(let e=0;e<r.length;e++)r[e].classList.add("show");c=!1,e()},p=document.querySelector("#site-gallery-name"),v=()=>{const e=document.querySelector("#site-interactive");"results"===n?(c=!1,(()=>{const e=t.results.total;let n=0;i=setInterval((()=>{c||(d(l(s+"results/"+Math.floor(Math.random()*e+1)+".jpg")),++n>20&&(clearInterval(i),a=setInterval((()=>{c||(u(),d(l(s+"results/"+Math.floor(Math.random()*e+1)+".jpg")))}),5e3)))}),100)})(),p.innerHTML="WNFA/心的铁片",e.classList.add("lightup")):"posters"===n&&(c=!1,p.innerHTML="回想回想",(()=>{const e=t.posters.total;let n=1;i=setInterval((()=>{c||(d(l(s+"posters/"+String(n)+".jpg")),++n>e&&clearInterval(i))}),100)})(),e.classList.add("lightup"))};return v(),{clean:e=>{c=!0,clearInterval(i),clearInterval(a),h((()=>{document.querySelector("#site-interactive").classList.remove("lightup"),setTimeout((()=>{e()}),1e3)}))},refresh:()=>{c=!0,clearInterval(i),clearInterval(a),h((()=>{document.querySelector("#site-interactive").classList.remove("lightup"),setTimeout((()=>{v()}),1e3)}))},hide:e=>{m((()=>{setTimeout((()=>{e()}),1e3)}))},show:e=>{g((()=>{setTimeout((()=>{e()}),1e3)}))}}}function i(){const i=document.querySelector("#site-interactive"),a=document.querySelector("#site-interactive .room"),c=document.querySelector("#site-interactive .room .gallery");new e,function(o,s,r){const i=()=>{const e=o.getBoundingClientRect();t.pointerX=e.left+e.width/2,t.pointerY=e.top+e.height/2},a=()=>{const e=r.getBoundingClientRect(),t=e.width/e.height,n=document.querySelector("#site-prompt"),o=document.querySelector("#site-prompt .prompt");if(t<.4||t>2.5)o.innerHTML="Window ratio not supported",n.style.visibility="visible";else{n.style.visibility="hidden",o.innerHTML="";const e=document.querySelector("#site-interactive");t<1?e.classList.add("vertical"):e.classList.remove("vertical")}};i(),t.focusX=t.pointerX,t.focusY=t.pointerY,a(),r.onmousemove=o=>{if(n){if(e.getInstance().clickDown)if(null===t.rotateOrigin)t.rotateOrigin=o.clientX;else{const e=o.clientX-t.rotateOrigin,n=90/1080;t.rotateDeg=(t.rotateDeg+4*e*n)%360,t.rotateOrigin=o.clientX}t.pointerX=o.clientX,t.pointerY=o.clientY}},r.ontouchmove=o=>{if(n){if(e.getInstance().clickDown)if(null===t.rotateOrigin)t.rotateOrigin=o.touches[0].clientX;else{const e=o.touches[0].clientX-t.rotateOrigin,n=90/1080;t.rotateDeg=(t.rotateDeg+4*e*n)%360,t.rotateOrigin=o.touches[0].clientX}t.pointerX=o.touches[0].clientX,t.pointerY=o.touches[0].clientY}};const c=()=>{t.rotateOrigin=null,e.getInstance().clickDown=!0},l=()=>{e.getInstance().clickDown=!1};r.addEventListener("mousedown",(e=>{c()})),r.addEventListener("touchstart",(e=>{c()})),r.addEventListener("touchend",(e=>{l()})),r.addEventListener("touchcancel",(e=>{l()})),document.addEventListener("mouseup",(e=>{l()})),document.addEventListener("mouseleave",(e=>{l()})),window.onblur=()=>{l(),n=!1,i()},window.onfocus=()=>{n=!0,i()};const d=window.getComputedStyle(s).transform,u=n=>{window.requestAnimationFrame((i=>{const a=1/((i-n)/1e3);var c;e.getInstance().canRotate()&&(t.rotateDeg=(t.rotateDeg+360/(60/(1/a)))%360),function(e){Math.abs(t.pointerX-t.focusX)>10?t.focusX=t.focusX+(t.pointerX-t.focusX)/(.25*e):t.pointerX=t.focusX,Math.abs(t.pointerY-t.focusY)>10?t.focusY=t.focusY+(t.pointerY-t.focusY)/(.25*e):t.pointerY=t.focusY}(a),function(e,n){const o=10,s=e.getBoundingClientRect(),r=n.getBoundingClientRect(),i=r.height/r.width,a=o*i,c=o/i,l=s.left+s.width/2,d=s.top+s.height/2,u=t.focusX-l,h=t.focusY-d,m=u/(r.width/2),g=h/(r.height/2);let p=m*a/((r.height+600)/600),v=-g*c/((r.width+600)/600);Math.abs(p)>o&&(p=p/Math.abs(p)*o),Math.abs(v)>o&&(v=v/Math.abs(v)*o),e.style.transform=`rotateX(${v}deg) rotateY(${p}deg)`}(o,r),c=d,s.style.transform=c+`rotateY(${t.rotateDeg}deg)`,u(i)}))};window.requestAnimationFrame((e=>{u(e)})),window.addEventListener("resize",(()=>{a(),i()}))}(a,c,i),function(e){for(let t=0;t<6;t++){const n=60+60*t,s=document.createElement("div");s.classList.add("wall"),s.style.transform=`rotateY(${n}deg) translateX(-50%)`,o.push(s),e.appendChild(s)}var t;t=e=>{let t=["posters","results"],n=r(e,"results");document.querySelector("#site-button-refresh").onclick=()=>{n.refresh()},document.querySelector("#site-button-next").onclick=()=>{const o=t.shift();t.push(o),n.clean((()=>{n=r(e,o)}))};const o=document.querySelector("#site-button-info");document.querySelector("#site-interactive .room .gallery");let s=!1;const i=()=>{s=!0,n.hide((()=>{}))},a=()=>{s=!1,n.show((()=>{}))};o.addEventListener("touchstart",(e=>{e.preventDefault(),i()})),o.addEventListener("touchend",(e=>{e.preventDefault(),a()})),o.addEventListener("touchcancel",(e=>{e.preventDefault(),a()})),o.addEventListener("mousedown",(e=>{e.preventDefault(),i()})),o.addEventListener("mouseup",(e=>{e.preventDefault(),a()})),document.addEventListener("mouseup",(e=>{s&&a()}))},fetch(s+"META.json").then((e=>{200===e.status&&e.json().then((e=>{t(e)}))})).catch((e=>{console.log("error",e)}))}(c);const l=document.querySelector("#site-button-info"),d=document.querySelector("#site-button-next"),u=document.querySelector("#site-button-refresh"),h=document.createElement("div"),m=document.createElement("div"),g=document.createElement("div");h.classList.add("icon"),m.classList.add("icon"),g.classList.add("icon"),h.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" width="${"0.75em"}" viewBox="0 0 74 74"><rect width="74" height="74" fill="none"/><path d="M40.657,38.124h10.2L50.8,77.772H40.657ZM45.731,19a6.122,6.122,0,1,1-6.122,6.122A6.122,6.122,0,0,1,45.731,19Z" transform="translate(-8.786 -11.12)" fill="${"rgb(58, 58, 58)"}"/></svg>`,m.innerHTML=((e,t)=>`<svg xmlns="http://www.w3.org/2000/svg" width="${t}" viewBox="0 0 74 74"><rect width="74" height="74" fill="none"/><g transform="translate(-28.581 6.732)"><g transform="translate(48.224)"><g transform="translate(0)"><path d="M52.745,60.535l-4.521-4.57,26.546-25.7L48.224,4.568,52.745,0,82.939,30.269Z" transform="translate(-48.224)" fill="${e}"/></g></g></g></svg>`)("rgb(225, 225, 225)","0.75em"),g.innerHTML=((e,t)=>`<svg xmlns="http://www.w3.org/2000/svg" width="${t}" viewBox="0 0 74 74"><rect width="74" height="74" fill="none"/><path d="M55.148,13.867a29.123,29.123,0,0,0-7.136-7.619L54.23,0h-18.1V18.184l8.455-8.5a24.242,24.242,0,1,1-38.1,19.885A24.092,24.092,0,0,1,20.139,7.757L18.045,3.45a29.033,29.033,0,1,0,37.1,10.417Z" transform="translate(6.273 7.697)" fill="${e}"/></svg>`)("rgb(225, 225, 225)","0.75em"),l.appendChild(h),d.appendChild(m),u.appendChild(g)}window.addEventListener("load",(()=>{const e=document.querySelector("#site-prompt"),t=document.querySelector("#site-prompt .prompt"),n=["loading<br>.","loading<br>. .","loading<br>. . ."];let o=0,s=setInterval((()=>{t.innerHTML=n[o],o=(o+1)%n.length}),750);setTimeout((()=>{clearInterval(s),t.innerHTML="",e.style.visibility="hidden",i()}),3e3)}))})();